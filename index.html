<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
  integrity="sha256-kLaT2GOSpHechhsozzB+flnD+zUyjE2LlfWPgU04xyI="
  crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-WBkoXOwTeyKclOHuWtc+i2uENFpDZ9YPdf5Hf+D7ewM=" crossorigin=""></script>
  <script>
    // Need co-ordinates of each station
    // Dispatch each train
    // Somehow need to simulate the time (but quickly) or do I?
    const stations = {
      "Ballina": [54.1113, -9.1571],
      "Castlebar": [53.8465, -9.2999],
      "Claremorris": [53.72074, -9.00230],
      "Foxford": [53.9751, -9.1379],
      "Manulla": [53.8294, -9.1928],
      "Westport": [53.7938, -9.5045]
    };


    var routes = {
        "Ballina-Manulla": ["Ballina", "Foxford", "Manulla"],
        "Ballina-Westport": ["Ballina", "Foxford", "Manulla", "Castlebar", "Westport"],
        "Castlebar-Manulla": ["Castlebar", "Manulla"],
        "Claremorris-Westport": ["Claremorris", "Manulla", "Castlebar", "Westport"],
        "Manulla-Ballina": ["Manulla", "Foxford", "Ballina"],
        "Manulla-Castlebar": ["Manulla", "Castlebar"],
        "Manulla-Westport": ["Manulla", "Castlebar", "Westport"],
        "Westport-Ballina": ["Westport", "Castlebar", "Manulla", "Foxford", "Ballina"],
        "Westport-Claremorris": ["Westport", "Castlebar", "Manulla", "Claremorris"],
        "Westport-Manulla": ["Westport", "Castlebar", "Manulla"],
    }

    var trainIcon = L.icon({
      iconUrl: 'train.png',

      iconSize: [15, 15], // size of the icon
      shadowSize: [15, 15], // size of the shadow
      // iconAnchor: [22, 94], // point of the icon which will correspond to marker's location
      // shadowAnchor: [4, 62],  // the same for the shadow
      // popupAnchor: [-3, -76] // point from which the popup should open relative to the iconAnchor
    });

    const sleep = (milliseconds) => {
      return new Promise(resolve => setTimeout(resolve, milliseconds))
    }

    async function dispatch(train, map) {
      for (const stop of routes[train.from]) {
        await L.marker(stations[stop], { icon: trainIcon }).addTo(map);
        await sleep(1000)
      }
    }

    async function fetchTrains(map) {
      const response = await fetch('./dispatch.json')
      const trains = await response.json();
      for (const train of trains) {
        await this.dispatch(train, map);
        await sleep(5000)
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      // https://www.openstreetmap.org/#map=10/53.9169/-9.6007&layers=T
      var map = L.map('map').setView([53.9169, -9.6007], 10);
      var tiles = new L.tileLayer('https://tile.thunderforest.com/transport/{z}/{x}/{y}.png?apikey=ea736ed47bed403b9317deba0ba09741', {
        attribution: '&copy; <a href="https://www.thunderforest.com/copyright">Thunderforest</a> contributors',
        minZoom: '10'
      }).addTo(map);

      fetchTrains(map)
    });
  </script>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    #map { height: 600px; width: 1000px;}
    .leaflet-marker-icon {
      transition: all 5s;
    }
  </style>
</head>
  <body>
    <div id="map"></div>
  </body>
</html>